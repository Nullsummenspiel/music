#include "music.h"
#include "delay.h"
#include "pwm.h"
#include "key.h"



unsigned char lasttune=0;
unsigned char m=0,n=0;
unsigned char musicflag=0;
unsigned char flag=0;


const short T[49]={0,                                                //const表示存放在rom中
  262,277,294,311,330,349,370,392,415,440,466,494,                   //低音区  1,12,2,23,3,4,45,5,56,6,67,7 共12个音调
	523,554,578,622,659,698,740,784,831,880,932,988,                   //中音区
	1046,1109,1175,1245,1318,1397,1480,1568,1661,1760,1865,1976        //高音区
};

const unsigned char music[][2]={{0,4},
{0,4},{24,4},{24,4},{21,4},{19,4},{21,4},{14,8},{19,4},{21,4},{24,4},{21,4},{19,16},{0,4},{24,4},{24,4},{21,4},{19,4},{21,4},{12,8},{19,4},{21,4},{24,4},{19,4},{17,16},{0,4},{17,4},{19,4},{21,4},
{24,4},{26,4},{24,4},{22,4},{24,4},{21,4},{21,4},{19,4},{19,16},{0,4},
{17,4},{19,4},{17,4},{17,4},{19,4},{17,4},{19,4},{19,4},{21,8},{24,4},{21,4},{21,12},{0,4},{24,4},{24,4},{21,4},{19,4},{21,4},{14,8},{19,4},{21,4},{24,4},{21,4},{19,16},{0,4},{24,4},{24,4},{21,4},
{19,4},{21,4},{12,8},{19,4},{21,4},{24,4},{19,4},{17,16},{0,4},{17,4},{19,4},{21,4},{24,4},{26,4},{24,4},{22,4},{24,4},{21,4},{21,4},{19,4},{19,12},{12,4},{21,8},{19,4},{19,8},{17,16},
{0xFF,0xFF}};

const unsigned char music1[][2]={{0,4},                    //爱情买卖
{22,4},{22,4},{17,4},{15,4},{15,4},{17,12},
{15,4},{15,2},{17,2},{15,4},{13,4},{13,4},{15,12},{0,4},
{20,4},{20,4},{20,4},{17,4},{20,4},{20,4},{20,4},{17,4},
{22,4},{17,4},{17,4},{15,4},{15,4},{17,12},
{22,4},{22,4},{17,4},{15,4},{15,4},{17,12},
{15,4},{15,2},{17,2},{15,4},{13,4},{13,4},{15,12},
{20,4},{20,4},{20,2},{17,2},{17,4},{20,4},{20,4},{20,2},{17,2},{17,2},{17,2},
{24,4},{20,4},{20,2},{17,2},{17,4},{20,4},{22,12},
{17,4},{22,4},{25,4},{25,4},{17,4},{22,4},{25,8},
{24,4},{22,2},{24,2},{22,4},{20,4},{15,4},{17,12},
{15,4},{15,4},{15,4},{10,4},{15,4},{17,4},{20,8},
{17,4},{24,4},{24,4},{20,4},{15,4},{17,12},
{17,4},{22,4},{25,4},{25,4},{17,4},{22,4},{25,8},
{29,4},{27,2},{29,2},{27,4},{25,4},{25,4},{27,12},
{29,4},{29,2},{27,4},{25,4},{27,6},{27,2},{25,4},{24,4},
{20,4},{20,2},{17,2},{20,4},{20,2},{22,2},{22,16},
{0xFF,0xFF}};

void Music_Init(void)
{
	lasttune=0;
	m=0;
	n=0;
}

//音乐播放器进程
void Music_Task(unsigned char x)
{
	while (1) 
	{
			//if(KEY0==0)
		//	{
			//	lasttune=0;
			//	m=0,n=0;
				//music_run(1);
				//Music_Task();
			//}

		//if(KEY1==0)
		//{
		//		music_run(0);
		//}
	if(x==1)
	{
		if(musicflag!=0)
		{	
			flag=1;
			if(n<=0)
			{
				TIM1_PWM_setFrequency(0);
				if(music[m][1]==0xff)
				{
					musicflag=0;
					flag=0;
				}
				else 
				{
					n=music[m][1];
					if(music[m][0]==lasttune)  //如果此次音调和上次相同，则延迟半个小节
					{
						delay_ms(1000/24);
					}
					lasttune=music[m][0];
					TIM1_PWM_setFrequency(T[music[m][0]]);
					m++;
			  }
			}
			
			n--;
		}

		
		delay_ms(1000/12);
	}

	if(x==2)
	{
		if(musicflag!=0)
		{	
			flag=1;
			if(n<=0)
			{
				TIM1_PWM_setFrequency(0);
				if(music1[m][1]==0xff)
				{
					musicflag=0;
					flag=0;
				}
				else 
				{
					n=music1[m][1];
					if(music1[m][0]==lasttune)  //如果此次音调和上次相同，则延迟半个小节
					{
						delay_ms(1000/24);
					}
					lasttune=music1[m][0];
					TIM1_PWM_setFrequency(T[music1[m][0]]);
					m++;
			  }
			}
			
			n--;
		}

		
		delay_ms(1000/12);
	}

		if(flag==0)
			break;
	}
}

void music_run(unsigned char flag)
{
	if(flag==1)
	{
		musicflag=1;
	}
	else
	{
		musicflag=0;
		TIM1_PWM_setFrequency(0);
	}
}
